---
title: "Proteomics, transcriptomics and radiomics data integration"
author: "Mafe Senosain"
date: "`r Sys.Date()`"
output:
    html_document:
        toc: true
        toc_float: true
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning=FALSE)
```

```{r}
library(ComplexHeatmap)
library(circlize)
library(tidyverse)
library(dplyr)
library(RCy3)
library(igraph)
library(cluster)
library(factoextra)
library(plotly) 
library(umap) 
source('src/rnaseq/30_DEGanalysis.R')
environment_set()
```

```{r}
all_vars_scaled <- read.csv('data/TMA36_project/data_integration/cytof_rna_hm.csv', row.names = 1)
all_vars_raw <- read.csv('data/TMA36_project/data_integration/cytof_rna_hm_raw.csv', row.names = 1)
colnames(all_vars_scaled) = gsub('\\.', ' ', colnames(all_vars_scaled))
clusters_patients <- read.csv('data/TMA36_project/data_integration/clusters_patients.csv', row.names = 1)
clusters_features <- read.csv('data/TMA36_project/data_integration/clusters_features.csv', row.names = 1)
CDE = read.csv('data/TMA36_project/CDE/CDE_TMA36_2021SEPT21_DR_MF.csv')
CDE = CDE[match(rownames(all_vars_scaled), CDE$pt_ID),]
```

```{r}
# Add WES info to CDE
wes = read.csv("data/TMA36_project/WES/processed/wes_binary.csv")
colnames(wes)[1] = 'pt_ID'
CDE = left_join(CDE, wes, by = 'pt_ID')
# Add pt cluster to CDE
clusters_patients <- rownames_to_column(clusters_patients, var = 'pt_ID')
rownames(clusters_patients) <- clusters_patients$pt_ID
clusters_patients$pt_ID <- as.integer(clusters_patients$pt_ID)
CDE=left_join(CDE, clusters_patients, by = 'pt_ID')
```


```{r}
sc_rna <- c('12929', '13774', '7984', '14965', '12889', '8356', 
            '11918', '11522', '15002', '15467', '13634', '14428',
            '11817', '14958', '12935', '13636')
CDE$scrna_data <- 'No'
CDE$scrna_data[which(CDE$pt_ID %in%  sc_rna)] <- 'Yes'
```

```{r}
col_bh = c('ind' = '#3498DB', 'int' = 'grey72', 'agg'= '#EC7063')
col_sila = colorRamp2(c(0, 0.5, 1), c("white", "#653e87", "#0d0514"))
col_stage = c('Stage 0'='#42f5f2', 'Stage I'='#53d94c', 'Stage II' = '#e8a62c', 'Stage III' = '#e85e2c')

ha = HeatmapAnnotation(
  Behavior = as.factor(CDE$n_op2),
  SILA = CDE$SILA,
  Stage = CDE$Stages_simplified,
  Nodule_size = CDE$Path_Nodule_Size_cm,
  Histology = CDE$Hist_predominant,
  Smoking = CDE$Smoking_Status,
  #Pack_Yrs = CDE$Pack_Years,
  sc_rna = CDE$scrna_data,
  #Subclust = as.factor(clusters_patients2$cluster),
  #Log_mut_load = log(CDE$mut_load),
  KRAS = as.factor(CDE$KRAS),
  EGFR = as.factor(CDE$EGFR),
  col = list(Behavior = col_bh, 
             SILA = col_sila,
             Stage = col_stage),
  simple_anno_size = unit(0.5, "cm")
)
#row_ha = rowAnnotation(Subclust = as.factor(clusters_features2$cluster))

```

# Data integration: Heatmap
## Zoom out
```{r, fig.width = 10, fig.height = 6}
set.seed(0)
Heatmap(t(all_vars_scaled), name = "z-score",
        heatmap_legend_param = list(color_bar = "continuous"), 
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 8),
        row_split = clusters_features$cluster,
        #show_row_dend = FALSE,
        column_split = clusters_patients$cluster,
        top_annotation = ha, show_row_names = F
        #left_annotation = row_ha
        )

```

## Zoom in
```{r, fig.width = 10, fig.height = 40}
set.seed(0)
Heatmap(t(all_vars_scaled), name = "z-score",
        heatmap_legend_param = list(color_bar = "continuous"), 
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 8),
        row_split = clusters_features$cluster,
        column_split = clusters_patients$cluster,
        top_annotation = ha, show_row_names = T
        #left_annotation = row_ha
        )

```

# Data integration: PCA

## PCA features k=4
```{r, fig.width = 6, fig.height = 6}
library(PCAtools)
clusters_features$cluster <- as.factor(clusters_features$cluster)
p <- pca(all_vars_scaled, metadata = clusters_features, center = F, scale = F)
biplot(p, colby='cluster', legendPosition='right',
       colLegendTitle = 'Cluster', encircle = T, 
       encircleFill = T)
```

## PCA patients k=4
```{r, fig.width = 6, fig.height = 6}
library(PCAtools)
clusters_patients$cluster <- as.factor(clusters_patients$cluster)
p <- pca(t(all_vars_scaled), metadata = clusters_patients, center = F, scale = F)
biplot(p, colby='cluster', legendPosition='right',
       colLegendTitle = 'Cluster', encircle = T, 
       encircleFill = T)
```



# UMAP

## Features 3D
```{r}
#https://plotly.com/r/t-sne-and-umap-projections/
ft_umap = umap(t(all_vars_scaled), n_components = 3, random_state = 15) 
layout <- ft_umap[["layout"]] 
layout <- data.frame(layout) 
final <- cbind(layout, cluster=clusters_features$cluster, features=rownames(clusters_features)) 
col_pal <- RColorBrewer::brewer.pal(length(unique(final$cluster)), 'Dark2')

fig <- plot_ly(final, x = ~X1, y = ~X2, z = ~X3, color = ~final$cluster, colors = col_pal,
               hoverinfo='text',
               text = ~paste('</br> Cluster: ', cluster,
                             '</br> Feature: ', features)) %>% 
  add_markers(opacity = 0.5, marker = list(size=7)) %>% 
  layout(scene = list(xaxis = list(title = '0'), 
                                     yaxis = list(title = '1'), 
                                     zaxis = list(title = '2'))) 

fig
```

## Patients 3D
```{r}
ft_umap = umap(all_vars_scaled, n_components = 3, random_state = 15) 
layout <- ft_umap[["layout"]] 
layout <- data.frame(layout) 
final <- cbind(layout, cluster=clusters_patients$cluster, features=rownames(clusters_patients), CDE) 
col_pal <- RColorBrewer::brewer.pal(length(unique(final$cluster)), 'Dark2')

fig <- plot_ly(final, x = ~X1, y = ~X2, z = ~X3, color = ~final$cluster, colors = col_pal,
               hoverinfo='text',
               text = ~paste('</br> Cluster: ', cluster,
                             '</br> Feature: ', features,
                             '</br> SILA: ', SILA,
                             '</br> SILA_cat: ', n_op2,
                             '</br> Path stage: ', X8th_ed_path_stage)) %>% 
  add_markers(opacity = 0.5, marker = list(size=7)) %>% 
  layout(scene = list(xaxis = list(title = '0'), 
                                     yaxis = list(title = '1'), 
                                     zaxis = list(title = '2'))) 

fig
```

# Survival analysis

## All vs all
### Overall survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '2', '3', '4'), 
              delete_group=FALSE, survival_type = 'OS', 
              legend_labs = c('1', '2', '3', '4'), legend_title = 'patient cluster')
```

### RF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '2', '3', '4'), 
              delete_group=FALSE, survival_type = 'RFS', 
              legend_labs = c('1', '2', '3', '4'), legend_title = 'patient cluster')
```

### PF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '2', '3', '4'), 
              delete_group=FALSE, survival_type = 'PFS', 
              legend_labs = c('1', '2', '3', '4'), legend_title = 'patient cluster')
```

## Survival 1 vs 2-3-4
```{r}
CDE$cluster_j <- CDE$cluster
CDE$cluster_j[CDE$cluster != '1'] <- '2-3-4'
```

### Overall survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('1', '2-3-4'), 
              delete_group=FALSE, survival_type = 'OS', 
              legend_labs = c('1', '2-3-4'), legend_title = 'patient cluster')
```

### RF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('1', '2-3-4'), 
              delete_group=FALSE, survival_type = 'RFS', 
              legend_labs = c('1', '2-3-4'), legend_title = 'patient cluster')
```

### PF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('1', '2-3-4'), 
              delete_group=FALSE, survival_type = 'PFS', 
              legend_labs = c('1', '2-3-4'), legend_title = 'patient cluster')
```

## Survival 2 vs 1-3-4
```{r}
CDE$cluster_j <- CDE$cluster
CDE$cluster_j[CDE$cluster != '2'] <- '1-3-4'
```

### Overall survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('2', '1-3-4'), 
              delete_group=FALSE, survival_type = 'OS', 
              legend_labs = c('2', '1-3-4'), legend_title = 'patient cluster')
```

### RF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('2', '1-3-4'), 
              delete_group=FALSE, survival_type = 'RFS', 
              legend_labs = c('2', '1-3-4'), legend_title = 'patient cluster')
```

### PF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('2', '1-3-4'), 
              delete_group=FALSE, survival_type = 'PFS', 
              legend_labs = c('2', '1-3-4'), legend_title = 'patient cluster')
```

## Survival 3 vs 1-2-4
```{r}
CDE$cluster_j <- CDE$cluster
CDE$cluster_j[CDE$cluster != '3'] <- '1-2-4'
```

### Overall survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('3', '1-2-4'), 
              delete_group=FALSE, survival_type = 'OS', 
              legend_labs = c('3', '1-2-4'), legend_title = 'patient cluster', rmst2_tau=3.5)
```

### RF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('3', '1-2-4'), 
              delete_group=FALSE, survival_type = 'RFS', 
              legend_labs = c('3', '1-2-4'), legend_title = 'patient cluster', rmst2_tau=3.5)
```

### PF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('3', '1-2-4'), 
              delete_group=FALSE, survival_type = 'PFS', 
              legend_labs = c('3', '1-2-4'), legend_title = 'patient cluster', rmst2_tau=3.5)
```

## Survival 4 vs 1-2-3
```{r}
CDE$cluster_j <- CDE$cluster
CDE$cluster_j[CDE$cluster != '4'] <- '1-2-3'
```

### Overall survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('4', '1-2-3'), 
              delete_group=FALSE, survival_type = 'OS', 
              legend_labs = c('4', '1-2-3'), legend_title = 'patient cluster')
```

### RF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('4', '1-2-3'), 
              delete_group=FALSE, survival_type = 'RFS', 
              legend_labs = c('4', '1-2-3'), legend_title = 'patient cluster')
```

### PF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster_j', group_levels=c('4', '1-2-3'), 
              delete_group=FALSE, survival_type = 'PFS', 
              legend_labs = c('4', '1-2-3'), legend_title = 'patient cluster')
```

## Survival 1 vs 2

### Overall survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '2'), 
              delete_group=FALSE, survival_type = 'OS', 
              legend_labs = c('1', '2'), legend_title = 'patient cluster')
```

### RF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '2'), 
              delete_group=FALSE, survival_type = 'RFS', 
              legend_labs = c('1', '2'), legend_title = 'patient cluster')
```

### PF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '2'), 
              delete_group=FALSE, survival_type = 'PFS', 
              legend_labs = c('1', '2'), legend_title = 'patient cluster')
```

## Survival 1 vs 3

### Overall survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '3'), 
              delete_group=FALSE, survival_type = 'OS', 
              legend_labs = c('1', '3'), legend_title = 'patient cluster')
```

### RF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '3'), 
              delete_group=FALSE, survival_type = 'RFS', 
              legend_labs = c('1', '3'), legend_title = 'patient cluster')
```

### PF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '3'), 
              delete_group=FALSE, survival_type = 'PFS', 
              legend_labs = c('1', '3'), legend_title = 'patient cluster')
```

## Survival 1 vs 4

### Overall survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '4'), 
              delete_group=FALSE, survival_type = 'OS', 
              legend_labs = c('1', '4'), legend_title = 'patient cluster')
```

### RF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '4'), 
              delete_group=FALSE, survival_type = 'RFS', 
              legend_labs = c('1', '4'), legend_title = 'patient cluster')
```

### PF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('1', '4'), 
              delete_group=FALSE, survival_type = 'PFS', 
              legend_labs = c('1', '4'), legend_title = 'patient cluster')
```

## Survival 2 vs 3

### Overall survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('2', '3'), 
              delete_group=FALSE, survival_type = 'OS', 
              legend_labs = c('2', '3'), legend_title = 'patient cluster')
```

### RF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('2', '3'), 
              delete_group=FALSE, survival_type = 'RFS', 
              legend_labs = c('2', '3'), legend_title = 'patient cluster')
```

### PF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('2', '3'), 
              delete_group=FALSE, survival_type = 'PFS', 
              legend_labs = c('2', '3'), legend_title = 'patient cluster')
```

## Survival 2 vs 4

### Overall survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('2', '4'), 
              delete_group=FALSE, survival_type = 'OS', 
              legend_labs = c('2', '4'), legend_title = 'patient cluster')
```

### RF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('2', '4'), 
              delete_group=FALSE, survival_type = 'RFS', 
              legend_labs = c('2', '4'), legend_title = 'patient cluster')
```

### PF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('2', '4'), 
              delete_group=FALSE, survival_type = 'PFS', 
              legend_labs = c('2', '4'), legend_title = 'patient cluster')
```


## Survival 3 vs 4

### Overall survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('3', '4'), 
              delete_group=FALSE, survival_type = 'OS', 
              legend_labs = c('3', '4'), legend_title = 'patient cluster')
```

### RF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('3', '4'), 
              delete_group=FALSE, survival_type = 'RFS', 
              legend_labs = c('3', '4'), legend_title = 'patient cluster')
```

### PF survival
```{r}
x <- survival_plot(CDE, group_colname='cluster', group_levels=c('3', '4'), 
              delete_group=FALSE, survival_type = 'PFS', 
              legend_labs = c('3', '4'), legend_title = 'patient cluster')
```
